<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>bKash Payment - FitLife</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #E2136E 0%, #C7004C 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .payment-container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .bkash-logo {
      text-align: center;
      margin-bottom: 30px;
    }

    .bkash-logo h1 {
      color: #E2136E;
      font-weight: 700;
      font-size: 48px;
      margin: 0;
    }

    .bkash-logo p {
      color: #666;
      font-size: 14px;
      margin-top: 5px;
    }

    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
      padding: 0 20px;
    }

    .step {
      flex: 1;
      text-align: center;
      position: relative;
    }

    .step::before {
      content: '';
      position: absolute;
      top: 15px;
      left: 50%;
      width: 100%;
      height: 2px;
      background: #e0e0e0;
      z-index: -1;
    }

    .step:first-child::before {
      display: none;
    }

    .step-circle {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #e0e0e0;
      color: #999;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 5px;
    }

    .step.active .step-circle {
      background: #E2136E;
      color: white;
    }

    .step.completed .step-circle {
      background: #28a745;
      color: white;
    }

    .step.completed::before {
      background: #28a745;
    }

    .step-label {
      font-size: 11px;
      color: #666;
      display: block;
    }

    .payment-info {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 25px;
    }

    .payment-info h5 {
      color: #333;
      font-weight: 600;
      margin-bottom: 15px;
      font-size: 16px;
    }

    .payment-info p {
      margin: 5px 0;
      color: #555;
      font-size: 14px;
    }

    .payment-info .amount {
      font-size: 28px;
      font-weight: 700;
      color: #E2136E;
      margin: 15px 0;
    }

    .form-label {
      font-weight: 500;
      color: #333;
      margin-bottom: 8px;
    }

    .form-control {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 12px 15px;
      font-size: 16px;
      transition: all 0.3s;
    }

    .form-control:focus {
      border-color: #E2136E;
      box-shadow: 0 0 0 0.2rem rgba(226, 19, 110, 0.25);
    }

    .btn-bkash {
      background: #E2136E;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 15px;
      font-size: 18px;
      font-weight: 600;
      width: 100%;
      margin-top: 20px;
      transition: all 0.3s;
    }

    .btn-bkash:hover:not(:disabled) {
      background: #C7004C;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(226, 19, 110, 0.3);
    }

    .btn-bkash:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .btn-secondary-action {
      background: transparent;
      color: #6c757d;
      border: 2px solid #dee2e6;
      border-radius: 10px;
      padding: 12px;
      font-size: 16px;
      font-weight: 500;
      width: 100%;
      margin-top: 10px;
      transition: all 0.3s;
    }

    .btn-secondary-action:hover {
      background: #f8f9fa;
      border-color: #6c757d;
      color: #495057;
    }

    .spinner-border {
      display: none;
      width: 20px;
      height: 20px;
      margin-left: 10px;
    }

    .processing .spinner-border {
      display: inline-block;
    }

    .security-note {
      text-align: center;
      font-size: 12px;
      color: #888;
      margin-top: 20px;
    }

    .alert {
      border-radius: 10px;
      padding: 12px 15px;
      margin-bottom: 20px;
    }

    .info-box {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #856404;
    }

    .info-box strong {
      display: block;
      margin-bottom: 5px;
      color: #664d03;
    }

    .otp-display {
      background: #d4edda;
      border: 2px dashed #28a745;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      text-align: center;
    }

    .otp-display .otp-code {
      font-size: 32px;
      font-weight: 700;
      color: #155724;
      letter-spacing: 5px;
      font-family: 'Courier New', monospace;
    }

    .otp-display p {
      margin: 8px 0 0 0;
      font-size: 13px;
      color: #155724;
    }

    .confirmation-box {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .confirmation-box .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #dee2e6;
    }

    .confirmation-box .detail-row:last-child {
      border-bottom: none;
    }

    .confirmation-box .detail-label {
      color: #6c757d;
      font-size: 14px;
    }

    .confirmation-box .detail-value {
      color: #333;
      font-weight: 600;
      font-size: 14px;
    }

    .masked-phone {
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="payment-container">
    <div class="bkash-logo">
      <h1>bKash</h1>
      <p>Sandbox Payment (Test Mode)</p>
    </div>

    <!-- Step Indicator -->
    <div class="step-indicator">
      <div class="step {% if payment_step == 'phone' %}active{% elif payment_step != 'phone' %}completed{% endif %}">
        <div class="step-circle">1</div>
        <span class="step-label">Account</span>
      </div>
      <div class="step {% if payment_step == 'pin' %}active{% elif payment_step == 'otp' or payment_step == 'confirm' %}completed{% endif %}">
        <div class="step-circle">2</div>
        <span class="step-label">PIN</span>
      </div>
      <div class="step {% if payment_step == 'otp' %}active{% elif payment_step == 'confirm' %}completed{% endif %}">
        <div class="step-circle">3</div>
        <span class="step-label">OTP</span>
      </div>
      <div class="step {% if payment_step == 'confirm' %}active{% endif %}">
        <div class="step-circle">4</div>
        <span class="step-label">Confirm</span>
      </div>
    </div>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}

    <div class="payment-info">
      <h5>Payment Details</h5>
      <p><strong>Merchant:</strong> FitLife Platform</p>
      <p><strong>Plan:</strong> {{ enrollment.member }}</p>
      <div class="amount">‡ß≥ {{ enrollment.Price }}</div>
      <p style="font-size: 12px; color: #888; margin-top: 10px;">
        * This is a sandbox/test payment. No real money will be charged.
      </p>
    </div>

    <!-- Step 1: Phone Number -->
    {% if payment_step == 'phone' %}
    <form method="post" id="bkashForm">
      {% csrf_token %}
      <input type="hidden" name="action" value="verify_phone">
      
      <div class="info-box">
        <strong>üì± Test Account Numbers</strong>
        Use any valid 11-digit number starting with 013-019<br>
        Example: 01712345678
      </div>

      <div class="mb-3">
        <label for="phone" class="form-label">Enter your bKash Account Number</label>
        <input type="text" class="form-control" id="phone" name="phone" 
               placeholder="01XXXXXXXXX" pattern="01[3-9][0-9]{8}" required
               maxlength="11" autofocus>
        <small class="text-muted">Enter your 11-digit bKash mobile number</small>
      </div>

      <button type="submit" class="btn btn-bkash" id="payBtn">
        <span id="btnText">Proceed</span>
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
      </button>

      <a href="{% url 'enrollment' %}" class="btn btn-secondary-action">Cancel</a>
    </form>
    {% endif %}

    <!-- Step 2: PIN -->
    {% if payment_step == 'pin' %}
    <form method="post" id="bkashForm">
      {% csrf_token %}
      <input type="hidden" name="action" value="verify_pin">
      
      <div class="info-box">
        <strong>üîê Test PIN</strong>
        Enter any 5-digit number as your PIN<br>
        Example: 12345
      </div>

      <div class="mb-3">
        <label class="form-label">Account Number</label>
        <div class="form-control" style="background: #f8f9fa;">
          <span class="masked-phone">{{ phone|slice:":3" }}****{{ phone|slice:"-2:" }}</span>
        </div>
      </div>

      <div class="mb-3">
        <label for="pin" class="form-label">Enter your bKash PIN</label>
        <input type="password" class="form-control" id="pin" name="pin" 
               placeholder="‚óè ‚óè ‚óè ‚óè ‚óè" pattern="[0-9]{5}" required
               maxlength="5" autofocus>
        <small class="text-muted">Enter your 5-digit bKash PIN</small>
      </div>

      <button type="submit" class="btn btn-bkash" id="payBtn">
        <span id="btnText">Verify PIN</span>
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
      </button>

      <button type="submit" name="action" value="back" class="btn btn-secondary-action">Back</button>
    </form>
    {% endif %}

    <!-- Step 3: OTP -->
    {% if payment_step == 'otp' %}
    <form method="post" id="bkashForm">
      {% csrf_token %}
      <input type="hidden" name="action" value="verify_otp">
      
      <div class="otp-display">
        <p style="margin: 0 0 10px 0; font-weight: 600;">Your OTP Code (Sandbox Mode)</p>
        <div class="otp-code">{{ generated_otp }}</div>
        <p>Use this code to complete your payment</p>
      </div>

      <div class="info-box">
        <strong>üì≤ OTP Sent</strong>
        In production, OTP would be sent to {{ phone }}<br>
        For sandbox testing, use the code displayed above
      </div>

      <div class="mb-3">
        <label for="otp" class="form-label">Enter OTP</label>
        <input type="text" class="form-control" id="otp" name="otp" 
               placeholder="‚óè ‚óè ‚óè ‚óè ‚óè ‚óè" pattern="[0-9]{6}" required
               maxlength="6" autofocus>
        <small class="text-muted">Enter the 6-digit OTP code</small>
      </div>

      <button type="submit" class="btn btn-bkash" id="payBtn">
        <span id="btnText">Verify OTP</span>
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
      </button>

      <button type="submit" name="action" value="back" class="btn btn-secondary-action">Back</button>
    </form>
    {% endif %}

    <!-- Step 4: Confirmation -->
    {% if payment_step == 'confirm' %}
    <form method="post" id="bkashForm">
      {% csrf_token %}
      <input type="hidden" name="action" value="confirm_payment">
      
      <div class="confirmation-box">
        <h5 style="color: #333; margin-bottom: 15px; font-size: 16px;">Confirm Payment</h5>
        
        <div class="detail-row">
          <span class="detail-label">Merchant</span>
          <span class="detail-value">FitLife Platform</span>
        </div>
        
        <div class="detail-row">
          <span class="detail-label">Subscription Plan</span>
          <span class="detail-value">{{ enrollment.member }}</span>
        </div>
        
        <div class="detail-row">
          <span class="detail-label">Account</span>
          <span class="detail-value masked-phone">{{ phone|slice:":3" }}****{{ phone|slice:"-2:" }}</span>
        </div>
        
        <div class="detail-row">
          <span class="detail-label">Amount</span>
          <span class="detail-value" style="color: #E2136E; font-size: 18px;">‡ß≥ {{ enrollment.Price }}</span>
        </div>
      </div>

      <div class="info-box">
        <strong>‚úì Ready to Pay</strong>
        Please review the details above and confirm your payment
      </div>

      <button type="submit" class="btn btn-bkash" id="payBtn">
        <span id="btnText">Confirm & Pay ‡ß≥ {{ enrollment.Price }}</span>
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
      </button>

      <button type="submit" name="action" value="back" class="btn btn-secondary-action">Back</button>
    </form>
    {% endif %}

    <div class="security-note">
      <p>üîí Secured by bKash Payment Gateway (Sandbox)</p>
      <p style="margin-top: 5px;">This is a test environment. No actual transaction will occur.</p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Handle form submission with loading state
    const form = document.getElementById('bkashForm');
    if (form) {
      form.addEventListener('submit', function(e) {
        const submitBtn = this.querySelector('button[type="submit"]:not([name="action"])');
        if (submitBtn && !submitBtn.hasAttribute('name')) {
          submitBtn.classList.add('processing');
          submitBtn.disabled = true;
          
          const btnText = submitBtn.querySelector('#btnText');
          if (btnText) {
            btnText.textContent = 'Processing...';
          }
        }
      });
    }

    // Auto-format phone number input
    const phoneInput = document.getElementById('phone');
    if (phoneInput) {
      phoneInput.addEventListener('input', function(e) {
        // Remove non-numeric characters
        this.value = this.value.replace(/[^0-9]/g, '');
      });
    }

    // Auto-format PIN input
    const pinInput = document.getElementById('pin');
    if (pinInput) {
      pinInput.addEventListener('input', function(e) {
        this.value = this.value.replace(/[^0-9]/g, '');
      });
    }

    // Auto-format OTP input
    const otpInput = document.getElementById('otp');
    if (otpInput) {
      otpInput.addEventListener('input', function(e) {
        this.value = this.value.replace(/[^0-9]/g, '');
      });
    }
  </script>
</body>
</html>
